<!--INFO 3300 Project 2-->
<!--Created by -->
<head>
    <title>Recipe Visualization</title>
    <link rel="stylesheet" href="css/stylesheet.css">
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
    <script src = 'script/underscore.js'></script> 
    <script src = 'script/script.js'></script>
    <script src = 'https://cdnjs.cloudflare.com/ajax/libs/fuse.js/2.6.1/fuse.min.js'></script> 
    <script src="script/search.js"></script>
	<link rel = "stylesheet" href = "css/animation.css">
    <style>
        /*svg {border: 1px black solid;}*/
        body {font-family: 'Alegreya Sans', Calibri, sans-serif;}
        #text {font-size: 15; font-weight: bold;}
		
		#personalInfo{
			width: 300px;
		}
		.labels{
			float: left;
			margin-left: 10px;
			margin-top: 3px;
		}
		.inputs{
			float: right;
			margin-right: 10px;
		}
		#data{
			float: right;
		}
		#pot{
			float: left;
		}
		.ingredients{
			position: fixed;
			top: 100px;
			right: 100px;
		}
	</style>
</head>
<body>
	<div id = "topText">
		<h1>What to eat?</h1>
		<div class = "sub">Insert some text about how this site works like instructions and such I guess probably should add more text to make this look longer and stuff but I don't really know what to write here yet. Also text about why this is important?? like nutrients and stuff???</div>
	</div>
	<div id = "pot">
		<svg id = "testSvg" width = "500" height = "500" style = "border: 1px black solid">
			<image y = "270" width = "500" xlink:href = "icon/pot.svg"></image>
		</svg>
		<form>
			<input type ='text' id = 'search-box'></input>
			<input type = 'submit' id = 'submit'></input>
		</form>
<div id = "error"><p id = "errorMessage"></p></div>
	</div>
	<div id = "data">
		<div id = "recipesContainer">
			<h2 id = 'ing-name'>Recipes</h2>
			<h3 id = "recipe-list"></h3>

		</div>
		<div id = "graph">
			<svg id = "barGraph" width = '700' height = '900'>
				<g id = "axes"></g>
				<g id= "text"></g>
				<g id = "bars"></g>
			</svg>
			
			
			<div id  = "personalInfo">
				<form>
					<!-- unable to include other for gender as I have no idea how to calculate BMI for other genders-->
					<div class = "labels">
						Gender:<br>
						Weight(Lbs):</br>
						Height(Inches):</br>
						Age(Years):<br>
					</div>
					<div class = "inputs">
						<input type = "radio" name = "gender" value = "0"  checked = "true">Male 
						<input type = "radio" name = "gender" value = "1">Female<br>
						<input type = "range" min = "0" max = "400" value = "150" name = "weight"><br>
						<input type = "range" min = "0" max = "100" value = "70" name = "height"><br>
						<input type = "range" min = "0" max = "200" value = "30" name = "age"><br>
					</div>
					<input type = "submit" value = "submit">
				</form>
			</div>
		</div>
	</div>    
</body>
<script>
    var recipe_ing, recipe_cal, scale, recipe_data, slow_write, data, data2, recipe_search_list;
    var color_scale = ['#67001f','#b2182b','#d6604d','#f4a582','#fddbc7','black','#e0e0e0','#bababa','#878787','#4d4d4d','#1a1a1a'];
    var nutrient_list = ['Calories', 'Fat', 'Cholesterol','Carbohydrates', 'Fiber','Sugar',
     'Protein', 'Calcium', 'Iron', 'Vitamin A', 'Vitamin C'];
    var svg = d3.select("#barGraph");
	var instructionsActive = false;
	var search_count = 0;
   // svg.append("rect").attr("width", 2000).attr("height", 1200).style("fill", "green").style("fill-opacity", 0.1);

	d3.queue()
	//load recipe data from epicurious.com
	//load nutrition data from usda
    .defer(d3.json, "data/recipe_to_nutrition_final.json")
    .defer(d3.json, "data/nutrition_reduced.json")
    .defer(d3.json, "data/full_format_recipes.json")
    .await(function (error, file1, file2, file3) {
        console.log(error);
        //{recipe: {ing1:{NDBNo:#, magnitude:#, unit: 'gram'}, ing2: {NDBNo:#, magnitude:#, unit: 'gram'}}, recipe2...}
        recipe_ing = {};
        recipe_cal = {};
        recipe_search_list = [];
        var removed_recipes = {};
        for (var i = 0; i < file3.length; i++){
        	if (file3[i]['calories'] != null){
            	recipe_cal[file3[i]['title']] = file3[i]['calories'];
            }
            else{
            	removed_recipes[file3[i]['title']] = file3[i]['title'];
            }
        }
        for (var i = 0; i < file1.length; i++){
            var title = Object.keys(file1[i])[0];
            if (removed_recipes[title]==null){
            	 recipe_ing[title] = file1[i][title];
            	 recipe_search_list.push({'title': title, 'ingredients': Object.keys(file1[i][title])});
            }
        }
        //console.log(recipe_search_list);
        ing_nut = file2;
        var scales = [];

        //at some point, prevent enter pressing/make it call search function

        var options = {keys:['ingredients'], id: 'title'};
		var fuse = new Fuse (recipe_search_list, options);

        $("#search-box").keyup(function(){
	        var val = this.value;
            if(!val.match("^[a-zA-Z0-9]*$")){
            console.log("Wrong");
            document.getElementById("errorMessage").innerHTML = "Please re-type.";
            }
			var results = slow_write(val);
        });
        for (var i = 0; i < 10; i++){
        	d3.select("#recipesContainer").append("div").attr("class", "recipe-box").attr("id", "recipe-name-box"+i);
        	d3.select("#recipe-name-box"+i).append("p").attr("id", "recipe-name"+i)//.attr("onclick", "toggleInstruction('#recipe-name-box"+i" .ingredients')");	
        	for (var j = 0; j <10; j++){
        		d3.select("#recipe-name-box"+i).append("p").attr("id", "ingredients"+j).attr("class", "ingredients");
        	}
        }

        var slow_write = _.debounce( function(term){
        	search_count += 1;
		    fuse.search(term);
			var results = fuse.results;

	        document.getElementById("recipe-list").innerHTML = "You searched for: " + term + " <br>";
	        for (var i = 0; i < 10; i++){
	            var recipe_name = results[i]['item'];
		        document.getElementById("recipe-name"+i).innerHTML = recipe_name;
		        var ing_list = Object.keys(recipe_ing[recipe_name]);
	            for (var j = 0; j < 10; j++){
	               	d3.select("#ingredients"+j).text(ing_list[j]);
	            }
        	}
	       	var axis_x = 12;
	        var axis_y = 63;
	        var base_x = 15;
	        var base_y = 65;
	        //var domain = findMax(results[0]['item'], recipe_ing, ing_nut, [2500, 30, 81, 160]);
	       	console.log(search_count)
	        if (search_count == 1){
	        	create_axis(scales, axis_x, axis_y/*,  /*domain*/);
	        	console.log(results[0]['item']);
				create_graph(results[0]['item'], recipe_ing, recipe_cal, ing_nut, scales, base_x, base_y);
	        }
	        else{
	        	update_graph(results[0]['item'], recipe_ing, recipe_cal, ing_nut, scales, base_x, base_y);
	        }
	        
		}, 500);
  
    });
	
	/* Macronutrient Calculator */
	function BMRCalculator(gender, weight, height, age){
		//gender: 0 = male, 1 = female
		if (gender == 1)
			return 655.1 + (4.35 * weight) + (4.7 * height) - (4.7 * age);
		else
			return 66 + (6.2 * weight) + (12.7 * height) - (6.76 * age);
	}
	
	function caloriesCalculator(exercise, BMR){
		return BMR * (1.2 + exercise * 0.175);
	}
	
	function macronutrientCalculator(ratio, calories){
		//ratio = 0, body building ratio 50-30-20 (carb-protein-fat)
		//ratio = 1, maintenance ratio 40-30-30
		//ratio = 2, fat loss ratio 20-35-45
		if (ratio == 0)
			return [calories * .5 / 4, calories * .3 / 4, calories * .2 / 9];
		else if (ratio == 1)
			return [calories * .4 / 4, calories * .3 / 4, calories * .3 / 9];
		else if (ratio == 2)
			return [calories * .2 / 4, calories * .35 / 4, calories * .45 / 9];
		else
			return [281, 112.5, 75];
	}
	
	/* Animation/Interface Functions */
	function getIcon(ingredient){
		$.ajax({
			url: "icon/" + ingredient + ".svg",
			type: "HEAD",
			error: function(){fadeInText(ingredient);},
			success: function(){fadeIn(ingredient);}
		});
	}
	
	function fadeIn(element){
		svg = d3.select("#testSvg");
		svg.append("image")
				.attr("x", Math.random() * 400 + 50)
				.attr("y", 0)
				.attr("height", 50)
				.attr("width", 50)
				.attr("class", "fade fall")
				.attr("id", element)
				.attr("xlink:href", "./icon/" + element + ".svg");
	}
	
	function fadeInText(element){
		svg = d3.select("#testSvg");
		svg.append("text")
				.attr("x", Math.random() * 400 + 50)
				.attr("y", 0)
				.text(element)
				.attr("class", "fade fall")
				.attr("id", element);
	}
	
	function toggleInstruction(element){
		if (d3.select(element).style("display") == "none" && !instructionsActive){
			d3.select(element).style("display", "block");
			instructionsActive = true;
		}
		else {
			d3.select(element).style("display", "none");
			instructionsActive = false;
		}
	}
</script>
